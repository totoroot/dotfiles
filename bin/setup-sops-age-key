#!/usr/bin/env bash
set -euo pipefail

key_dir="/var/lib/sops-nix"
host="$(hostname -s)"
key_file="${key_dir}/${host}.txt"
ssh_key="/home/${SUDO_USER:-$USER}/.ssh/${host}"

if [[ -f "$key_file" ]]; then
  echo "sops-nix age key already exists at ${key_file}"
  echo "Public key:"
  rg -n "public key:" "$key_file" || true
  exit 0
fi

if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root (writes to ${key_dir})."
  exit 1
fi

mkdir -p "$key_dir"

if [[ -f "$ssh_key" ]]; then
  ssh-to-age -private-key < "$ssh_key" > "$key_file"
else
  echo "Host SSH key not found at ${ssh_key}. Falling back to age-keygen."
  age-keygen -o "$key_file"
fi

chmod 600 "$key_file"

echo "Generated sops-nix age key at ${key_file}"
echo "Public key:"
rg -n "public key:" "$key_file" || true
