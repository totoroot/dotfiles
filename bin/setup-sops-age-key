#!/usr/bin/env bash
set -euo pipefail

key_dir="/var/lib/sops-nix"
host="$(hostname -s)"
key_file="${key_dir}/${host}.txt"
ssh_key="/home/${SUDO_USER:-$USER}/.ssh/${host}"
repo_root="$(cd "$(dirname "$0")/.." && pwd)"
secrets_file="${repo_root}/secrets/${host}.yaml"

if [[ -f "$key_file" ]]; then
  echo "sops-nix age key already exists at ${key_file}"
  echo "Public key:"
  sudo age-keygen -y "$key_file"
  if [[ ! -f "$secrets_file" ]]; then
    cat >"$secrets_file" <<'EOF'
# Add host secrets here, e.g.
# my-service:
#   env: "..."
EOF
    echo "Created stub secrets file: ${secrets_file}"
  fi
  exit 0
fi

if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root (writes to ${key_dir})."
  exit 1
fi

mkdir -p "$key_dir"

if [[ -f "$ssh_key" ]]; then
  ssh-to-age -private-key < "$ssh_key" > "$key_file"
  used_ssh_to_age="true"
else
  echo "Host SSH key not found at ${ssh_key}. Falling back to age-keygen."
  age-keygen -o "$key_file"
  used_ssh_to_age="false"
fi

chmod 600 "$key_file"

echo "Generated sops-nix age key at ${key_file}"
echo "Public key:"
sudo age-keygen -y "$key_file"

if [[ ! -f "$secrets_file" ]]; then
  cat >"$secrets_file" <<'EOF'
# Add host secrets here, e.g.
# my-service:
#   env: "..."
EOF
  echo "Created stub secrets file: ${secrets_file}"
fi

echo "Encrypt the secrets file like this:"
echo "  sops --encrypt --age \"age1...${host^^}_PUBLIC_KEY...\" -i ${secrets_file}"
